[**![English_lang](https://user-images.githubusercontent.com/125398461/229074810-599bd7f9-0bc1-44a9-b76e-90bf7e182314.png) English**](https://github.com/hiddify/hiddify-config/wiki/Guide-for-finding-a-clean-Cloudflare-IP)

<div dir="rtl">

# چگونگی یافتن آیپی تمیز کلادفلر

بزرگترین ارائه دهنده خدمات CDN در جهان کلادفلر است و احتمالا می دانید؛ به دلیل فیلترینگ شدید اینترنت در ایران اختلال زیادی روی سرویس های آن وجود دارد زیرا امکان فیلتر نمودن کامل آن برای فیلترچی مقدور نیست اما می تواند روی آن اختلال ایجاد کند. 

در اینجا اگر شما نیز از سرویس های CDN کلادفلر استفاده می کنید؛ متاثر از این اختلالات خواهید شد. برای کاهش تاثیر این اختلالات می بایست آیپی های تمیز (آیپی هایی که اختلالی روی آن نیست) را پیدا کرد.

در اینجا چند راه کار برای این موضوع معرفی و بررسی می گردد.

نکته:
> قبل از شروع تاکید می شود تمامی این تست ها روی سیستم کلاینت و بدون اتصال به VPN باید انجام شوند.

## استفاده از اسکریپت آقای مرتضی باشسیز
آقای باشسیز یک مهندس ایرانی است که برنامه ای تحت عنوان CFScanner توسعه داده است که با استفاده از آن می توان لیست آیپی های کلادفلر را بر روی شبکه های مختلف تست نمود و به آیپی های تمیز کلادفلر رسید.

این برنامه در دو نسخه لینوکس و ویندوز منتشر شده است.
برای این کار در ابتدا از [اینجا](https://github.com/MortezaBashsiz/CFScanner) نسخه مدنظر خود را دانلود کنید و سپس نحوه اجرای آن را بر اساس سیستم عامل مورد نظر دنبال کنید.

</div>


<details dir=rtl><summary><h3>اجرا در نسخه لینوکس</h3>(کلیک کنید)</summary>

<div dir="rtl" align=center>




<!--
https://www.youtube.com/watch?v=BKLRAHolhvM
-->


 فایل های برنامه را دانلود کنید و ابتدا توضیحات آقای باشسیز درباره نحوه اجرا را در ویدئوی زیر ببینید.

<a href="https://www.youtube.com/watch?v=cgV6uPBty90"><img width="50%" src="https://user-images.githubusercontent.com/125398461/234840939-ec06a505-0d37-45f3-b3b2-00f0a384cca0.png" /></a>

</div>

<div dir="rtl">

این برنامه پیش نیازهایی دارد که باید از قبل نصب باشند.
[jq](https://stedolan.github.io/jq/)&nbsp;&nbsp;&nbsp;[git](https://git-scm.com/)&nbsp;&nbsp;&nbsp;[tput](https://command-not-found.com/tput)&nbsp;&nbsp;&nbsp;[bc](https://www.gnu.org/software/bc/)&nbsp;&nbsp;&nbsp;[curl](https://curl.se/download.html)&nbsp;&nbsp;&nbsp;
[parallel](https://www.gnu.org/software/parallel/)


سپس ابتدا آن را با کد زیر روی سیستم خود clone کنید.

</div>

```
git clone https://github.com/MortezaBashsiz/CFScanner.git 
```


<div dir="rtl">

به پوشه دانلود برنامه بروید و به آن دسترسی اجرا دهید.
</div>

```
cd CFScanner/bash
chmod +x ../bin/*
```

<div dir="rtl">

فایل config.real را دانلود کنید.

</div>

```
curl -s https://raw.githubusercontent.com/MortezaBashsiz/CFScanner/main/bash/ClientConfig.json -o config.real
```

<div dir="rtl">

توصیه می شود فایل config.real را بر اساس کانفیگ خود تغییر دهید.
</div>

![Screenshot_20230305_094935](https://user-images.githubusercontent.com/125398461/222945619-756a8a4c-9cd7-4977-8679-c5a3a5b9b96c.png)

<div dir="rtl">

اگر می خواهید فایل کانفیگ خود را داشته باشید آن را به اسم دیگری ذخیره کنید که هنگام آپدیت اسکریپت تغییر نکند.

#### اجرای اسکریپت 

به محل فایل اسکریپت دانلود شده بروید و سپس اسکریپت را به شکل زیر اجرا کنید

</div>

```
bash cfScanner.sh SUBNET DOWN threads tryCount config.real speed custom.subnets
```


![Screenshot_20230305_101318](https://user-images.githubusercontent.com/125398461/222946688-bcec3d65-7bf1-495a-b1bf-fe517f69f882.png)
<div dir="rtl">
مثلا
</div>

```
bash cfScanner.sh SUBNET DOWN 8 1 config.real 100 custom.subnets
```
<div dir="rtl">

در نهایت نتیجه تست در پوشه result قرار می گیرد که میتوانید آن را ملاحظه کنید و از آن استفاده نمایید. اطلاعات بیشتر در [ویکی](https://github.com/MortezaBashsiz/CFScanner/tree/main/bash) برنامه

</div>

</details>


<details dir=rtl><summary><h3>اجرا در نسخه ویندوز</h3>(کلیک کنید)</summary>



<details><summary><h4>پیش‌نیازها<h4></summary>

<div dir=rtl>

ابتدا باید پیش‌نیازهایی وجود داشته باشند که به ترتیب توضیح داده خواهند شد:

- دانلود اپ اسکنر ویندوز از [گیتهاب پروژه](https://github.com/MortezaBashsiz/CFScanner/tree/main/windows)

- اپ .NET Desktop Runtime 6 را نصب کنید از سایت اصلی برنامه که در زیر آورده شده
‍‍‍‍
</div>

<div dir=ltr>

```
https://dotnet.microsoft.com/en-us/download/dotnet/6.0
```

</div>

<div dir"rtl">

- چک نمودن TLS Handshake

برای این کار ابتدا باید وارد پوشه برنامه بشید و Command Prompt از داخل آن پوشه را باز نمایید. یعنی در پوشه `شیفت+راست‌کلیک` را بزنید و گزینه `Open in Windows Terminal` را بزنید. 

در محیط ترمینال کامند زیر را اجرا کنید.

</div>

<div dir=ltr>

‍‍`.\v2ray.exe tls ping sub.yourdomain.com`


</div>

<div dir="rtl">

به جای `sub.yourdomain.com` ساب‌دامین خودتون را بذارید. اگر پیغام `handshake succeeded` ظاهر شد؛ یعنی اسکنر آماده استفاده است در غیر اینصورت باید در تنظیمات سرتیفیکت در سایت کلادفلر به صورت موقت تغییراتی اعمال کنید.

ورژن TLS را روی TLS 1.0 بذارید و گزینه TLS 1.3 را غیر فعال کنید.

![](https://user-images.githubusercontent.com/125398461/234774581-c1a07bdb-352f-43cc-97f7-2ce6c87a761d.png)

* نکته: یادتون نره بعد انجام تست این گزینه‌ها را به حالت اول برگردونید.


- ساختارهای الگوی کانفیگ را برای تست آماده کنید.

اگر می‌خواهید کانفیگ‌های خودتون را تست کنید باید در فایل Json درون مربوط به کانکشن درون پوشه برنامه اعمال کنید. نیاز است در `inbound` این تغییر اعمال گردد.

</div>


<div dir="ltr">

```

{
  "inbounds": [{
    "port": "PORTPORT", 
    "listen": "127.0.0.1",
    "tag": "socks-inbound",
    "protocol": "socks",
    "settings": {
...
```

</div>

<div dir=rtl>

و همینطور اگر فرضا آیپی شما 1.1.1.1 باشد؛ در `outbound` نیز این تغییر اعمال گردد.

</div>

<div dir=ltr>

```
{
"outbounds": [
   {
   "protocol": "vmess",
   "settings": {
     "vnext": [{
       "address": "1.1.1.1",
...
```
</div>

</details>

حالا فرض  کنیم پیش‌نیازها را انجام دادید؛ کافیه فایل کانفیگ نمونه برنامه یا فایل کانفیگ ساخته شده توسط خودتون را که به فرمت Json است؛ از منوی `Tools > Add custom v2ray config` در برنامه قرار بدید تا اسکن بر اساس اون انجام بشه در غیر اینصورت برنامه با کانفیگ دیفالت اسکن می‌کند.

![](https://user-images.githubusercontent.com/125398461/234803794-7c7f5bb9-0967-4f1b-b519-9db266b7a0e7.png)

۱. از مسبر Tools > Add custom v2ray config می‌توانید فایل مورد نظر خود را مطابق با الگوی توضیح داده شده به نرم‌افزار بدید تا اسکن بر اساس اون انجام بشه.

۲. می‌توانید نوع تست دانلود یا آپلود یا هردو را تعیین کنید.

۳. در این قسمت می توانید تعداد همزمانی آیپی‌ها برای تست توسط اسکنر را مشخص کنید. پیشنهاد می‌گردد به صورت مرحله‌ای این عدد را بالا ببرید و بر اساس قدرت پردازش CPU سیستم خود آن را کم یا زیاد کنید. مثدار دیفالت آن ۴ می‌باشد.

۴. سریع‌ترین آیپی بعد از اتمام اسکن نمایش داده می‌شه

۵. رنج آیپی‌های تست شده نمایش داده می‌شه

۶. از این قسمت می‌تونید رنج آیپی‌های مورد نظر خود را به نرم‌افزار بدید که اسکن بر اساس آن انجام بشه.

* **پیشنهاد:** می‌تونید نرم‌افزار را تنظیم کنید که یک‌بار کل رنج آیپی دیفالت را اسکن کنه. برای دفعالت بعد می‌تونید این خروجی را فقط اسکن کنید (با دقت بالاتر) احتمالا نتیجه بهتری خواهید گرفت. همچنین اگر تست آپلود بگیرید احتمالا نتیجه بهتری خواهید گرفت. همه اینها به تلاش و خلاقیت خودتون بستگی داره.

</details>


<div dir="rtl">

## بعد از یافتن آیپی تمیز چکار کنیم؟

پس از یافتن آیپی تمیز؛ می توانید آن را با یک رکورد dns بدون پروکسی ثبت نمایید. یعنی در سایت کلادفلر یک ساب دامین بسازید. پروکسی را خاموش کنید و آیپی را وارد کنید.

![Screenshot_20230302_171704](https://user-images.githubusercontent.com/125398461/222942018-f53bf1bd-77c4-45b5-9604-0224061869d0.png)
در صورت نیاز به توضیحات بیشتر درباره دامنه [اینجا](https://github.com/hiddify/hiddify-config/wiki/%D8%A7%D9%86%D9%88%D8%A7%D8%B9-%D8%AF%D8%A7%D9%85%D9%86%D9%87-%D9%88-%D9%86%D8%AD%D9%88%D9%87-%D8%AB%D8%A8%D8%AA-%E2%80%8C%D8%A2%D9%86%E2%80%8C%D9%87%D8%A7) کلیک کنید.

سپس در پنل هیدیفای می توانید آن را در تنظیمات دامنه CDN در فیلد **اجبار به استفاده از هاست در کانفیگ CDN**  قرار دهید. [توضیحات بیشتر](https://github.com/hiddify/hiddify-config/wiki/%D9%86%D8%AD%D9%88%D9%87-%D9%BE%DB%8C%DA%A9%D8%B1%D8%A8%D9%86%D8%AF%DB%8C-%D9%BE%D9%86%D9%84-%D9%87%DB%8C%D8%AF%DB%8C%D9%81%D8%A7%DB%8C#%D8%AF%D8%A7%D9%85%D9%86%D9%87-cdn)

![Screenshot_20230301_095103](https://user-images.githubusercontent.com/125398461/222942200-ce36835f-41d9-4bc9-abf5-a4c35c34d33f.png)

</div>

